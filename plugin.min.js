tinymce.PluginManager.add("codehelper",function(e,t){let o="chrome-extension"==window.origin.substring(0,16)?"app":"web",n=t+"/codemirror-5.65.7",i=t+"/highlight.js-11.5.1",l="codehelper",s="codehelper",a="web"==o?16:20,r="web"==o?10:8,c=0;function d(e){return e&&"PRE"===e.nodeName.toUpperCase()&&e.firstChild&&"CODE"===e.firstChild.nodeName.toUpperCase()}function h(){let t=function t(){if(e.selection){let o=e.selection.getNode();if(d(o))return o}return null}(),o,n=new Ext.data.JsonStore({autoDestroy:!0,fields:["text","value"],data:(o=[],hljs.listLanguages().forEach(e=>{o.push({text:hljs.getLanguage(e).name,value:e})}),o.sort((e,t)=>e.text.toLowerCase()>t.text.toLowerCase()?1:-1),[{text:"自动",value:"auto"},...o])}),i=new SYNO.ux.ComboBox({xtype:"syno_combobox",itemCls:"codehelper-languageSeletcor",id:"language",name:"language",value:t?t.firstChild.className.match(/language-(\w+)/)[1]:"auto",store:n,displayField:"text",valueField:"value",hideLabel:!0,mode:"local",scope:this,listeners:{select:function(e,t,o,n){this.ownerCt.ownerCt.editorField.changeMode(v(t.data.value))}}});new CodeHelper.Window({title:"插入/编辑代码块",width:850,height:550,mode:v(t?t.firstChild.className.match(/language-(\w+)/)[1]:""),node:t,value:t?t.firstChild.textContent:"",toolbar:{item:i,height:28},onSubmit:function(t){var o,n,i;o=t.language,n=t.code,i=this.node,n&&e.undoManager.transact(function(){if(n=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils").DOM.encode(n),i){let t=i.firstChild;"auto"===o?e.dom.setAttrib(t,"class",""):e.dom.setAttrib(t,"class","language-"+o),t.innerHTML=n,hljs.highlightElement(t),e.selection.select(i)}else{let l='<pre><code id="__new"'+("auto"===o?"":' class="language-'+o+'"')+">"+n+"</code></pre>";e.insertContent(l),e.selection.select(e.$("#__new").removeAttr("id")[0])}})}}).show()}function _(e){return new Promise((t,o)=>{let n=[].slice.call(document.querySelectorAll("script")).map(e=>e.src);if(n.includes(e))return t();let i=document.createElement("script");i.type="text/javascript"})}function _(e){return new Promise((t,o)=>{if(""==e)return t();let n=[].slice.call(document.querySelectorAll("script")).map(e=>e.src);if(n.includes(e))return t();let i=document.createElement("script");i.type="text/javascript",i.src=e,document.body.appendChild(i),i.onload=()=>{t()},i.onerror=e=>{o(e)}})}function u(e){return new Promise((t,o)=>{if(""==e)return t();let n=[].slice.call(document.querySelectorAll("link")).map(e=>e.href);if(n.includes(e))return t();let i=document.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=e,document.head.appendChild(i),i.onload=()=>{t()},i.onerror=e=>{o(e)}})}function f(e,t){let o=document.getElementById(t);o&&o.remove(),o=document.createElement("style"),t&&(o.id=t),o.type="text/css",o.appendChild(document.createTextNode(e)),document.head.appendChild(o)}function p(e){e&&!e.getOption("fullScreen")&&e.setOption("fullScreen",!0)}function $(e){e&&e.getOption("fullScreen")&&e.setOption("fullScreen",!1)}function m(e,t){return e.getCursor(),(!t||t())&&setTimeout(function(){e.state.completionActive||e.showHint({completeSingle:!1})},100),CodeMirror.Pass}function g(e){return m(e,function(){var t=e.getCursor();return"<"==e.getRange(CodeMirror.Pos(t.line,t.ch-1),t)})}function x(e){return m(e,function(){var t=e.getTokenAt(e.getCursor());return!!("string"!=t.type||/['"]/.test(t.string.charAt(t.string.length-1))&&1!=t.string.length)&&(0,CodeMirror.innerMode(e.getMode(),t.state).state.tagName)})}function b(e){let t={bash:[{condition:[/(^|\|\s*)(\w+)(?!\w)/gm],overwrite:"$1<span class='hljs-built_in'>$2</span>"},{condition:[/(?<!\S)(-{1,2}[A-Za-z0-9]*)(?!\w)/gm],overwrite:"<span class='hljs-attr'>$1</span>"},]}[e.language];if(t)for(let o in t)for(let n in t[o].condition){let i=e.value;for(let l in htmls=i.match(/<[^>]*>[^<]*<\/[^>]*>/g))i=i.replace(/<[^>]*>[^<]*<\/[^>]*>/,"#"+l+"#");for(let s in i=i.replace(t[o].condition[n],t[o].overwrite),htmls)i=i.replace("#"+s+"#",htmls[s]);e.value=i}}function v(e){return(map={bash:"text/x-sh",c:"text/x-csrc",cpp:"text/x-c++src",csharp:"text/x-csharp",css:"text/css",diff:"text/x-diff",go:"text/x-go",ini:"text/x-properties",java:"text/x-java",javascript:"text/javascript",json:"application/json",kotlin:"text/x-kotlin",less:"text/x-less",lua:"text/x-lua",makefile:"text/x-cmake",markdown:"text/x-markdown",objectivec:"text/x-objectivec",perl:"text/x-perl",php:"application/x-httpd-php","php-template":"text/x-php",plaintext:"",python:"text/x-python","python-repl":"text/x-cython",r:"text/x-rsrc",ruby:"text/x-ruby",rust:"rust",scss:"text/x-scss",shell:"text/x-sh",sql:"text/x-sql",swift:"text/x-swift",typescript:"application/typescript",vbnet:"text/x-vb",xml:"application/xml",yaml:"text/x-yaml"})[e]?map[e]:""}return Promise.all([_(n+"/lib/codemirror.js"),_(i+"/highlight.min.js"),u(n+"/lib/codemirror.css"),u("default"!=l?n+"/theme/"+l+".css":""),]).then(e=>Promise.all([_(n+"/mode/meta.js"),_(n+"/mode/htmlmixed/htmlmixed.js"),_(n+"/mode/xml/xml.js"),_(n+"/mode/javascript/javascript.js"),_(n+"/mode/css/css.js"),_(n+"/addon/mode/loadmode.js"),_(n+"/addon/mode/simple.js"),_(n+"/addon/fold/foldcode.js"),_(n+"/addon/fold/foldgutter.js"),_(n+"/addon/fold/xml-fold.js"),_(n+"/addon/fold/brace-fold.js"),_(n+"/addon/fold/comment-fold.js"),_(n+"/addon/edit/closebrackets.js"),_(n+"/addon/edit/matchbrackets.js"),_(n+"/addon/edit/matchtags.js"),_(n+"/addon/edit/closetag.js"),_(n+"/addon/hint/show-hint.js"),_(n+"/addon/hint/xml-hint.js"),_(n+"/addon/hint/html-hint.js"),_(n+"/addon/display/fullscreen.js"),_(n+"/addon/dialog/dialog.js"),_(n+"/addon/search/searchcursor.js"),_(n+"/addon/search/search.js"),_(n+"/addon/search/matchesonscrollbar.js"),_(n+"/addon/search/jump-to-line.js"),_(n+"/addon/scroll/annotatescrollbar.js"),u(n+"/addon/fold/foldgutter.css"),u(n+"/addon/hint/show-hint.css"),u(n+"/addon/display/fullscreen.css"),u(n+"/addon/dialog/dialog.css"),u(n+"/addon/search/matchesonscrollbar.css"),])).then(e=>{Ext.define("CodeHelper.Editor",{extend:"SYNO.ux.TextArea",mode:null,theme:null,editorConfig:{},initComponent:function(){this.initialized=!1,CodeMirror.modeURL=n+"/mode/%N/%N.js",f("div.codehelper-formpanel div.x-form-field-wrap{margin-bottom:6px;}div.codehelper-formpanel form.x-panel-body{padding:"+r+"px "+a+"px;}.ext-el-mask{background: black;opacity: 0.7;}","codehelp_css"),this.on({afterrender:function(){let e=this,t={theme:e.theme||l,lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,matchTags:{bothTags:!0},autoCloseBrackets:!0,autoCloseTag:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],extraKeys:{"Ctrl-J":"toMatchingTag","Shift-Space":"autocomplete","'<'":m,"'/'":g,"' '":x,"'='":x,"Ctrl-F11":p,ESC:$}};Ext.applyIf(e.editorConfig,t),CodeHelper.Editor.superclass.initComponent.apply(this,arguments),e.codeEditor=CodeMirror.fromTextArea(e.el.dom,e.editorConfig),e.codeEditor.on("change",function(){e.fireEvent("change",e,e.codeEditor.getValue())}),e.codeEditor.on("blur",function(){e.fireEvent("blur",e)}),e.codeEditor.on("focus",function(){e.fireEvent("focus",e)}),(function(){e.changeMode(e.mode),e.codeEditor.focus()}).defer(201),e.codeEditor.getWrapperElement().parentElement.style.width=e.container.dom.clientWidth-2*a+"px",e.codeEditor.getWrapperElement().parentElement.style.height=e.container.dom.clientHeight-c-2*r+"px",e.codeEditor.setSize(e.container.dom.clientWidth-2*a,e.container.dom.clientHeight-c-2*r),e.codeEditor.execCommand("goDocEnd"),e.initialized=!0,(function(){e.codeEditor.refresh()}).defer(1)},resize:function(e,t,o){e.codeEditor&&(e.codeEditor.getWrapperElement().parentElement.style.width=t+"px",e.codeEditor.getWrapperElement().parentElement.style.height=o-c+"px",e.codeEditor.setSize(t,o-c))}},this)},getValue:function(){return this.initialized&&this.codeEditor.save(),CodeHelper.Editor.superclass.getValue.apply(this,arguments)},setValue:function(e){var t=this;return this.initialized&&(this.codeEditor.setValue(e||""),(function(){t.codeEditor.refresh()}).defer(1)),CodeHelper.Editor.superclass.setValue.apply(this,arguments)},validate:function(){this.getValue(),CodeHelper.Editor.superclass.validate.apply(this,arguments)},changeMode:function(e){let t,o,n;if(t=/.+\.([^.]+)$/.exec(e)){let i=CodeMirror.findModeByExtension(t[1]);i&&(o=i.mode,n=i.mime)}else if(/\//.test(e)){let l=CodeMirror.findModeByMIME(e);l&&(o=l.mode,n=e)}else o=n=e;o?(this.codeEditor.setOption("mode",n),CodeMirror.autoLoadMode(this.codeEditor,o)):this.codeEditor.setOption("mode","")}}),Ext.define("CodeHelper.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(e){this.width=850,this.height=560,this.owner=e.owner,this.callParent([this.fillConfig(e)])},fillConfig:function(e){var t={cls:"codehelper-window",width:e.width||this.width,width:e.height||this.height,autoHeight:!1,padding:"0px",layout:"fit",items:this.getFormPanel(e),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),handler:this.onCancel,scope:this},{disabled:!1,xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onOk,scope:this},],keys:[{key:Ext.EventObject.F11,ctrl:!0,fn:function(){p(this.editorField.codeEditor)},scope:this},{key:Ext.EventObject.ESC,fn:function(){$(this.editorField.codeEditor)},scope:this},],listeners:{resize:function(e,t,o,n,i){this.editorField.setSize(n-2*a,i-this.header.dom.clientHeight-this.footer.dom.clientHeight-2*r)}}};return Ext.apply(t,e)},getFormPanel:function(e){return this.formFields=[],e.toolbar?(this.formFields.push(e.toolbar.item),c=e.toolbar.height+6):c=0,this.editorField=new CodeHelper.Editor({xtype:"syno_cmcode",itemCls:"codehelper-editor",id:"code",name:"code",mode:e.mode,value:e.value,theme:l,hideLabel:!0,allowBlank:!0,enableKeyEvents:!0}),this.formFields.push(this.editorField),this.formPanel=new SYNO.ux.FormPanel({cls:"codehelper-formpanel",hideLabel:!1,hideLabels:!1,autoFlexcroll:!1,layout:"fit",items:this.formFields}),this.formPanel},onOk:function(){let e={};for(let t of this.formFields)e[t.name]=t.getValue();this.onSubmit(e),this.close()},onCancel:function(){this.close()},onEsc:function(){}}),hljs.addPlugin({"after:highlight":b})}),e.addCommand("editSrcCode",function t(){var o;let n,i;new CodeHelper.Window({title:"HTML源代码",width:850,height:550,value:(o=e.getContent(),n="",i="",o.split(/>\s*</).forEach(function(e){e.match(/^\/\w/)&&(i=i.substring(1)),n+=i+"<"+e+">\r\n",e.match(/^<?\w[^>]*[^\/]$/)&&!e.startsWith("input")&&(i+="	")}),n.substring(1,n.length-3)),mode:"htmlmixed",onSubmit:function(t){e.setContent(t.code)}}).show()}),e.addCommand("editCodeBlock",h),e.addCommand("editTitleBlock",function t(){e.undoManager.transact(function(){let t=`<div style="background-color: #ebf5ff; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border: 1px solid #b9d9f8; border-radius: 10px; margin-bottom: 10px; padding: 2px 10px 10px 10px;">
          <h3 id="title">填写标题</h3>
          <blockquote style="font-size: 0.8rem; border-left: 1px solid #b9d9f8;">填写副标题</span>
        </blockquote>
        </div>`;e.insertContent(t),e.selection.select(e.$("#__new").removeAttr("id")[0])})}),e.addButton("srccode",{icon:"srccode",tooltip:"HTML源代码",cmd:"editSrcCode"}),e.addButton("codeblock",{icon:"codeblock",tooltip:"插入/编辑代码块",cmd:"editCodeBlock",onSetup:function(t){let o=function(){t.setActive(isBeCodeSampleSelection())};return e.on("NodeChange",o),function(){return e.off("NodeChange",o)}}}),e.addButton("titleblock",{icon:"titleblock",tooltip:"插入标题块",cmd:"editTitleBlock"}),e.settings.toolbar="srccode | "+e.settings.toolbar.replace("hr","codeblock titleblock blockquote hr"),e.on("PreInit",function(e){for(let[o,n]of Object.entries({srccode:'<svg class="codehelp_svg" width="24" height="24" focusable="false" style="vertical-align: baseline"><path d="M9.8 15.7c.3.3.3.8 0 1-.3.4-.9.4-1.2 0l-4.4-4.1a.8.8 0 010-1.2l4.4-4.2c.3-.3.9-.3 1.2 0 .3.3.3.8 0 1.1L6 12l3.8 3.7zM14.2 15.7c-.3.3-.3.8 0 1 .4.4.9.4 1.2 0l4.4-4.1c.3-.3.3-.9 0-1.2l-4.4-4.2a.8.8 0 00-1.2 0c-.3.3-.3.8 0 1.1L18 12l-3.8 3.7z" fill="#505a64" fill-rule="nonzero"></path></svg>',codeblock:'<svg class="codehelp_svg" width="24" height="26" focusable="false" style="vertical-align: baseline"><path d="M7.1 11a2.8 2.8 0 01-.8 2 2.8 2.8 0 01.8 2v1.7c0 .3.1.6.4.8.2.3.5.4.8.4.3 0 .4.2.4.4v.8c0 .2-.1.4-.4.4-.7 0-1.4-.3-2-.8-.5-.6-.8-1.3-.8-2V15c0-.3-.1-.6-.4-.8-.2-.3-.5-.4-.8-.4a.4.4 0 01-.4-.4v-.8c0-.2.2-.4.4-.4.3 0 .6-.1.8-.4.3-.2.4-.5.4-.8V9.3c0-.7.3-1.4.8-2 .6-.5 1.3-.8 2-.8.3 0 .4.2.4.4v.8c0 .2-.1.4-.4.4-.3 0-.6.1-.8.4-.3.2-.4.5-.4.8V11zm9.8 0V9.3c0-.3-.1-.6-.4-.8-.2-.3-.5-.4-.8-.4a.4.4 0 01-.4-.4V7c0-.2.1-.4.4-.4.7 0 1.4.3 2 .8.5.6.8 1.3.8 2V11c0 .3.1.6.4.8.2.3.5.4.8.4.2 0 .4.2.4.4v.8c0 .2-.2.4-.4.4-.3 0-.6.1-.8.4-.3.2-.4.5-.4.8v1.7c0 .7-.3 1.4-.8 2-.6.5-1.3.8-2 .8a.4.4 0 01-.4-.4v-.8c0-.2.1-.4.4-.4.3 0 .6-.1.8-.4.3-.2.4-.5.4-.8V15a2.8 2.8 0 01.8-2 2.8 2.8 0 01-.8-2zm-3.3-.4c0 .4-.1.8-.5 1.1-.3.3-.7.5-1.1.5-.4 0-.8-.2-1.1-.5-.4-.3-.5-.7-.5-1.1 0-.5.1-.9.5-1.2.3-.3.7-.4 1.1-.4.4 0 .8.1 1.1.4.4.3.5.7.5 1.2zM12 13c.4 0 .8.1 1.1.5.4.3.5.7.5 1.1 0 1-.1 1.6-.5 2a3 3 0 01-1.1 1c-.4.3-.8.4-1.1.4a.5.5 0 01-.5-.5V17a3 3 0 001-.2l.6-.6c-.6 0-1-.2-1.3-.5-.2-.3-.3-.7-.3-1 0-.5.1-1 .5-1.2.3-.4.7-.5 1.1-.5z" fill-rule="evenodd" fill="#505a64"></path></svg>',titleblock:'<svg class="codehelp_svg" width="16" height="26" viewBox="0 0 512 512" focusable="false" style="vertical-align: baseline; margin-left:3px"><path d="M336.174 80c-49.132 0-93.305-32-161.913-32-31.301 0-58.303 6.482-80.721 15.168a48.04 48.04 0 0 0 2.142-20.727C93.067 19.575 74.167 1.594 51.201.104 23.242-1.71 0 20.431 0 48c0 17.764 9.657 33.262 24 41.562V496c0 8.837 7.163 16 16 16h16c8.837 0 16-7.163 16-16v-83.443C109.869 395.28 143.259 384 199.826 384c49.132 0 93.305 32 161.913 32 58.479 0 101.972-22.617 128.548-39.981C503.846 367.161 512 352.051 512 335.855V95.937c0-34.459-35.264-57.768-66.904-44.117C409.193 67.309 371.641 80 336.174 80zM464 336c-21.783 15.412-60.824 32-102.261 32-59.945 0-102.002-32-161.913-32-43.361 0-96.379 9.403-127.826 24V128c21.784-15.412 60.824-32 102.261-32 59.945 0 102.002 32 161.913 32 43.271 0 96.32-17.366 127.826-32v240z" fill="#505a64"/></svg>',blockquote:'<svg class="codehelp_svg" width="24" height="24" style="vertical-align: baseline"><path d="M7.5 17h.9c.4 0 .7-.2.9-.6L11 13V8c0-.6-.4-1-1-1H6a1 1 0 00-1 1v4c0 .6.4 1 1 1h2l-1.3 2.7a1 1 0 00.8 1.3zm8 0h.9c.4 0 .7-.2.9-.6L19 13V8c0-.6-.4-1-1-1h-4a1 1 0 00-1 1v4c0 .6.4 1 1 1h2l-1.3 2.7a1 1 0 00.8 1.3z" fill-rule="nonzero" fill="#505a64"></path></svg>'})){let l=document.getElementsByClassName("mce-i-"+o);l&&l[0]&&(l[0].innerHTML=n)}f(".mce-i-blockquote:before{content:''}.codehelp_svg:hover path{fill:#0086e6;}","codehelp_blockquote"),this.dom.styleSheetLoader.load(i+("default"==s?"/"+s+".min.css":"/styles/"+s+".css")),this.dom.styleSheetLoader.load(t+"/style/codehelper_content.css")}),e.on("SetContent",function(){let t=e.$("pre").filter(function(e,t){return d(t)}).filter(function(e,t){return"false"!==t.contentEditable});t.length&&e.undoManager.transact(function(){t.each(function(t,o){e.$(o).find("br").each(function(t,o){o.parentNode.replaceChild(e.getDoc().createTextNode("\n"),o)}),o.contentEditable="false";let n=o.firstChild;n.innerHTML=e.dom.encode(n.textContent),hljs.highlightElement(n),o.className=e.$.trim(o.className)})})}),e.on("PreProcess",function(t){e.$("pre[contenteditable=false]",t.node).filter(function(e,t){return d(t)}).each(function(t,o){e.$(o).removeAttr("contentEditable");let n=o.textContent,i=o.firstChild;e.$(i).empty(),i.textContent=n})}),e.on("click",function(t){let o=t.target,n=e.$(o).closest("pre");n.length>0&&d(n[0])?document.getElementsByClassName("mce-i-codeblock")[0].firstChild.firstChild.setAttribute("fill","#0095ff"):document.getElementsByClassName("mce-i-codeblock")[0].firstChild.firstChild.setAttribute("fill","#505a64")}),e.on("dblclick",function(t){let o=t.target,n=e.$(o).closest("pre");n.length>0&&d(n[0])&&h()}),{getMetadata:function(){return{name:"Code Helper"}}}});
