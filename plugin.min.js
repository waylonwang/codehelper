tinymce.PluginManager.add("codehelper",function(noteEditor,sourceUrl){let pluginName="Code Helper";let nsMode=window.origin.substring(0,16)=="chrome-extension"?"app":"web";let codeMirrorPath=sourceUrl+"/codemirror-5.65.7";let highLightPath=sourceUrl+"/highlight.js-11.5.1";let codeMirrorTheme="codehelper";let highLightTheme="codehelper";let panelBodyLeft=nsMode=="web"?16:20;let panelBodyTop=nsMode=="web"?10:8;let fieldGapMargin=6;let editorReduceHight=0;Promise.all([loadJs(codeMirrorPath+"/lib/codemirror.js"),loadJs(highLightPath+"/highlight.min.js"),loadCss(codeMirrorPath+"/lib/codemirror.css"),loadCss(codeMirrorTheme!="default"?codeMirrorPath+"/theme/"+codeMirrorTheme+".css":""),]).then((results)=>{return Promise.all([loadJs(codeMirrorPath+"/mode/meta.js"),loadJs(codeMirrorPath+"/mode/htmlmixed/htmlmixed.js"),loadJs(codeMirrorPath+"/mode/xml/xml.js"),loadJs(codeMirrorPath+"/mode/javascript/javascript.js"),loadJs(codeMirrorPath+"/mode/css/css.js"),loadJs(codeMirrorPath+"/addon/mode/loadmode.js"),loadJs(codeMirrorPath+"/addon/mode/simple.js"),loadJs(codeMirrorPath+"/addon/fold/foldcode.js"),loadJs(codeMirrorPath+"/addon/fold/foldgutter.js"),loadJs(codeMirrorPath+"/addon/fold/xml-fold.js"),loadJs(codeMirrorPath+"/addon/fold/brace-fold.js"),loadJs(codeMirrorPath+"/addon/fold/comment-fold.js"),loadJs(codeMirrorPath+"/addon/edit/closebrackets.js"),loadJs(codeMirrorPath+"/addon/edit/matchbrackets.js"),loadJs(codeMirrorPath+"/addon/edit/matchtags.js"),loadJs(codeMirrorPath+"/addon/edit/closetag.js"),loadJs(codeMirrorPath+"/addon/hint/show-hint.js"),loadJs(codeMirrorPath+"/addon/hint/xml-hint.js"),loadJs(codeMirrorPath+"/addon/hint/html-hint.js"),loadJs(codeMirrorPath+"/addon/display/fullscreen.js"),loadJs(codeMirrorPath+"/addon/dialog/dialog.js"),loadJs(codeMirrorPath+"/addon/search/searchcursor.js"),loadJs(codeMirrorPath+"/addon/search/search.js"),loadJs(codeMirrorPath+"/addon/search/matchesonscrollbar.js"),loadJs(codeMirrorPath+"/addon/search/jump-to-line.js"),loadJs(codeMirrorPath+"/addon/scroll/annotatescrollbar.js"),loadCss(codeMirrorPath+"/addon/fold/foldgutter.css"),loadCss(codeMirrorPath+"/addon/hint/show-hint.css"),loadCss(codeMirrorPath+"/addon/display/fullscreen.css"),loadCss(codeMirrorPath+"/addon/dialog/dialog.css"),loadCss(codeMirrorPath+"/addon/search/matchesonscrollbar.css"),])}).then((results)=>{Ext.define("CodeHelper.Editor",{extend:"SYNO.ux.TextArea",mode:null,theme:null,editorConfig:{},initComponent:function(){this.initialized=false;CodeMirror.modeURL=codeMirrorPath+"/mode/%N/%N.js";addCss("div.codehelper-formpanel div.x-form-field-wrap{margin-bottom:"+fieldGapMargin+"px;}div.codehelper-formpanel form.x-panel-body{padding:"+panelBodyTop+"px "+panelBodyLeft+"px;}.ext-el-mask{background: black;opacity: 0.7;}","codehelp_css");this.on({afterrender:function(){let self=this;let config={theme:self.theme||codeMirrorTheme,lineNumbers:true,lineWrapping:true,matchBrackets:true,matchTags:{bothTags:true},autoCloseBrackets:true,autoCloseTag:true,foldGutter:true,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],extraKeys:{"Ctrl-J":"toMatchingTag","Shift-Space":"autocomplete","'<'":completeAfter,"'/'":completeIfAfterLt,"' '":completeIfInTag,"'='":completeIfInTag,"Ctrl-F11":openFullscreen,ESC:closeFullscreen,},};Ext.applyIf(self.editorConfig,config);CodeHelper.Editor.superclass.initComponent.apply(this,arguments);self.codeEditor=CodeMirror.fromTextArea(self.el.dom,self.editorConfig);self.codeEditor.on("change",function(){self.fireEvent("change",self,self.codeEditor.getValue())});self.codeEditor.on("blur",function(){self.fireEvent("blur",self)});self.codeEditor.on("focus",function(){self.fireEvent("focus",self)});(function(){self.changeMode(self.mode);self.codeEditor.focus()}.defer(201));self.codeEditor.getWrapperElement().parentElement.style.width=self.container.dom.clientWidth-panelBodyLeft*2+"px";self.codeEditor.getWrapperElement().parentElement.style.height=self.container.dom.clientHeight-editorReduceHight-panelBodyTop*2+"px";self.codeEditor.setSize(self.container.dom.clientWidth-panelBodyLeft*2,self.container.dom.clientHeight-editorReduceHight-panelBodyTop*2);self.codeEditor.execCommand("goDocEnd");self.initialized=true;(function(){self.codeEditor.refresh()}.defer(1))},resize:function(self,width,height){if(self.codeEditor){self.codeEditor.getWrapperElement().parentElement.style.width=width+"px";self.codeEditor.getWrapperElement().parentElement.style.height=height-editorReduceHight+"px";self.codeEditor.setSize(width,height-editorReduceHight)}},},this)},getValue:function(){if(this.initialized){this.codeEditor.save()}return CodeHelper.Editor.superclass.getValue.apply(this,arguments)},setValue:function(v){var self=this;if(this.initialized){this.codeEditor.setValue(v||"");(function(){self.codeEditor.refresh()}.defer(1))}return CodeHelper.Editor.superclass.setValue.apply(this,arguments)},validate:function(){this.getValue();CodeHelper.Editor.superclass.validate.apply(this,arguments)},changeMode:function(val){let m,mode,spec;if((m=/.+\.([^.]+)$/.exec(val))){let info=CodeMirror.findModeByExtension(m[1]);if(info){mode=info.mode;spec=info.mime}}else if(/\//.test(val)){let info=CodeMirror.findModeByMIME(val);if(info){mode=info.mode;spec=val}}else{mode=spec=val}if(mode){this.codeEditor.setOption("mode",spec);CodeMirror.autoLoadMode(this.codeEditor,mode)}else{this.codeEditor.setOption("mode","")}},});Ext.define("CodeHelper.Window",{extend:"SYNO.SDS.NoteStation.ModalWindow",constructor:function(config){this.width=850;this.height=560;(this.owner=config.owner),this.callParent([this.fillConfig(config)])},fillConfig:function(config){var windowConfig={cls:"codehelper-window",width:config.width||this.width,width:config.height||this.height,autoHeight:false,padding:"0px",layout:"fit",items:this.getFormPanel(config),buttons:[{xtype:"syno_button",text:SYNO.SDS.NoteStation._T("common","cancel"),handler:this.onCancel,scope:this,},{disabled:false,xtype:"syno_button",btnStyle:"blue",text:SYNO.SDS.NoteStation._T("common","ok"),handler:this.onOk,scope:this,},],keys:[{key:Ext.EventObject.F11,ctrl:true,fn:function(){openFullscreen(this.editorField.codeEditor)},scope:this,},{key:Ext.EventObject.ESC,fn:function(){closeFullscreen(this.editorField.codeEditor)},scope:this,},],listeners:{resize:function(window,adjWidth,adjHeight,rawWidth,rawHeight){this.editorField.setSize(rawWidth-panelBodyLeft*2,rawHeight-this.header.dom.clientHeight-this.footer.dom.clientHeight-panelBodyTop*2)},},};return Ext.apply(windowConfig,config)},getFormPanel:function(config){this.formFields=[];if(config.toolbar){this.formFields.push(config.toolbar.item);editorReduceHight=config.toolbar.height+fieldGapMargin}else{editorReduceHight=0}this.editorField=new CodeHelper.Editor({xtype:"syno_cmcode",itemCls:"codehelper-editor",id:"code",name:"code",mode:config.mode,value:config.value,theme:codeMirrorTheme,hideLabel:true,allowBlank:true,enableKeyEvents:true,});this.formFields.push(this.editorField);this.formPanel=new SYNO.ux.FormPanel({cls:"codehelper-formpanel",hideLabel:false,hideLabels:false,autoFlexcroll:false,layout:"fit",items:this.formFields,});return this.formPanel},onOk:function(){let values={};for(let field of this.formFields){values[field.name]=field.getValue()}this.onSubmit(values);this.close()},onCancel:function(){this.close()},onEsc:function(){},});hljs.addPlugin({"after:highlight":highlightJsExtension,})});function isCodeBlock(node){return(node&&node.nodeName.toUpperCase()==="PRE"&&node.firstChild&&node.firstChild.nodeName.toUpperCase()==="CODE")}function getSelectedCodeBlock(){if(noteEditor.selection){let node=noteEditor.selection.getNode();if(isCodeBlock(node)){return node}}return null}function insertCodeBlock(language,code,node){if(!code)return;noteEditor.undoManager.transact(function(){code=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils").DOM.encode(code);if(node){let childNode=node.firstChild;if(language==="auto"){noteEditor.dom.setAttrib(childNode,"class","")}else{noteEditor.dom.setAttrib(childNode,"class","language-"+language)}childNode.innerHTML=code;hljs.highlightElement(childNode);noteEditor.selection.select(node)}else{let html='<pre><code id="__new"'+(language==="auto"?"":' class="language-'+language+'"')+">"+code+"</code></pre>";noteEditor.insertContent(html);noteEditor.selection.select(noteEditor.$("#__new").removeAttr("id")[0])}})}function openSourceCodeEditor(){new CodeHelper.Window({title:"HTML源代码",width:850,height:550,value:formatHTML(noteEditor.getContent()),mode:"htmlmixed",onSubmit:function(values){noteEditor.setContent(values.code)},}).show()}function openCodeBlockEditor(){let currentNode=getSelectedCodeBlock();let languageStore=new Ext.data.JsonStore({autoDestroy:!0,fields:["text","value"],data:(()=>{let languages=[];let hightLightJsLanguages=hljs.listLanguages();hightLightJsLanguages.forEach((lang)=>{languages.push({text:hljs.getLanguage(lang).name,value:lang})});languages.sort((a,b)=>{return a["text"].toLowerCase()>b["text"].toLowerCase()?1:-1});return[{text:"自动",value:"auto"},...languages]})(),});let languageField=new SYNO.ux.ComboBox({xtype:"syno_combobox",itemCls:"codehelper-languageSeletcor",id:"language",name:"language",value:currentNode?currentNode.firstChild.className.match(/language-(\w+)/)[1]:"auto",store:languageStore,displayField:"text",valueField:"value",hideLabel:true,mode:"local",scope:this,listeners:{select:function(obj,newValue,oldValue,eOpts){this.ownerCt.ownerCt.editorField.changeMode(convertLanugaeMIME(newValue.data.value))},},});new CodeHelper.Window({title:"插入/编辑代码块",width:850,height:550,mode:convertLanugaeMIME(currentNode?currentNode.firstChild.className.match(/language-(\w+)/)[1]:""),node:currentNode,value:currentNode?currentNode.firstChild.textContent:"",toolbar:{item:languageField,height:28,},onSubmit:function(values){insertCodeBlock(values.language,values.code,this.node)},}).show()}noteEditor.addCommand("editSrcCode",openSourceCodeEditor);noteEditor.addCommand("editCodeBlock",openCodeBlockEditor);noteEditor.addButton("srccode",{icon:"srccode",tooltip:"HTML源代码",cmd:"editSrcCode",});noteEditor.addButton("codeblock",{icon:"codeblock",tooltip:"插入/编辑代码块",cmd:"editCodeBlock",onSetup:function(api){let nodeChangeHandler=function(){api.setActive(isBeCodeSampleSelection())};noteEditor.on("NodeChange",nodeChangeHandler);return function(){return noteEditor.off("NodeChange",nodeChangeHandler)}},});noteEditor.settings.toolbar="srccode | "+noteEditor.settings.toolbar.replace("hr","codeblock blockquote hr");noteEditor.on("PreInit",function(e){const svgs={srccode:'<svg class="codehelp_svg" width="24" height="24" focusable="false" style="vertical-align: baseline"><path d="M9.8 15.7c.3.3.3.8 0 1-.3.4-.9.4-1.2 0l-4.4-4.1a.8.8 0 010-1.2l4.4-4.2c.3-.3.9-.3 1.2 0 .3.3.3.8 0 1.1L6 12l3.8 3.7zM14.2 15.7c-.3.3-.3.8 0 1 .4.4.9.4 1.2 0l4.4-4.1c.3-.3.3-.9 0-1.2l-4.4-4.2a.8.8 0 00-1.2 0c-.3.3-.3.8 0 1.1L18 12l-3.8 3.7z" fill="#505a64" fill-rule="nonzero"></path></svg>',codeblock:'<svg class="codehelp_svg" width="24" height="26" focusable="false" style="vertical-align: baseline"><path d="M7.1 11a2.8 2.8 0 01-.8 2 2.8 2.8 0 01.8 2v1.7c0 .3.1.6.4.8.2.3.5.4.8.4.3 0 .4.2.4.4v.8c0 .2-.1.4-.4.4-.7 0-1.4-.3-2-.8-.5-.6-.8-1.3-.8-2V15c0-.3-.1-.6-.4-.8-.2-.3-.5-.4-.8-.4a.4.4 0 01-.4-.4v-.8c0-.2.2-.4.4-.4.3 0 .6-.1.8-.4.3-.2.4-.5.4-.8V9.3c0-.7.3-1.4.8-2 .6-.5 1.3-.8 2-.8.3 0 .4.2.4.4v.8c0 .2-.1.4-.4.4-.3 0-.6.1-.8.4-.3.2-.4.5-.4.8V11zm9.8 0V9.3c0-.3-.1-.6-.4-.8-.2-.3-.5-.4-.8-.4a.4.4 0 01-.4-.4V7c0-.2.1-.4.4-.4.7 0 1.4.3 2 .8.5.6.8 1.3.8 2V11c0 .3.1.6.4.8.2.3.5.4.8.4.2 0 .4.2.4.4v.8c0 .2-.2.4-.4.4-.3 0-.6.1-.8.4-.3.2-.4.5-.4.8v1.7c0 .7-.3 1.4-.8 2-.6.5-1.3.8-2 .8a.4.4 0 01-.4-.4v-.8c0-.2.1-.4.4-.4.3 0 .6-.1.8-.4.3-.2.4-.5.4-.8V15a2.8 2.8 0 01.8-2 2.8 2.8 0 01-.8-2zm-3.3-.4c0 .4-.1.8-.5 1.1-.3.3-.7.5-1.1.5-.4 0-.8-.2-1.1-.5-.4-.3-.5-.7-.5-1.1 0-.5.1-.9.5-1.2.3-.3.7-.4 1.1-.4.4 0 .8.1 1.1.4.4.3.5.7.5 1.2zM12 13c.4 0 .8.1 1.1.5.4.3.5.7.5 1.1 0 1-.1 1.6-.5 2a3 3 0 01-1.1 1c-.4.3-.8.4-1.1.4a.5.5 0 01-.5-.5V17a3 3 0 001-.2l.6-.6c-.6 0-1-.2-1.3-.5-.2-.3-.3-.7-.3-1 0-.5.1-1 .5-1.2.3-.4.7-.5 1.1-.5z" fill-rule="evenodd" fill="#505a64"></path></svg>',blockquote:'<svg class="codehelp_svg" width="24" height="24" style="vertical-align: baseline"><path d="M7.5 17h.9c.4 0 .7-.2.9-.6L11 13V8c0-.6-.4-1-1-1H6a1 1 0 00-1 1v4c0 .6.4 1 1 1h2l-1.3 2.7a1 1 0 00.8 1.3zm8 0h.9c.4 0 .7-.2.9-.6L19 13V8c0-.6-.4-1-1-1h-4a1 1 0 00-1 1v4c0 .6.4 1 1 1h2l-1.3 2.7a1 1 0 00.8 1.3z" fill-rule="nonzero" fill="#505a64"></path></svg>',};for(let[key,svg]of Object.entries(svgs)){let icon=document.getElementsByClassName("mce-i-"+key);if(icon&&icon[0]){icon[0].innerHTML=svg}}addCss(".mce-i-blockquote:before{content:''}.codehelp_svg:hover path{fill:#0086e6;}","codehelp_blockquote");this.dom.styleSheetLoader.load(highLightPath+(highLightTheme=="default"?"/"+highLightTheme+".min.css":"/styles/"+highLightTheme+".css"));this.dom.styleSheetLoader.load(sourceUrl+"/codehelper_content.css")});noteEditor.on("SetContent",function(){let unprocessedCodeBlock=noteEditor.$("pre").filter(function(key,el){return isCodeBlock(el)}).filter(function(key,el){return el.contentEditable!=="false"});if(unprocessedCodeBlock.length){noteEditor.undoManager.transact(function(){unprocessedCodeBlock.each(function(idx,el){noteEditor.$(el).find("br").each(function(key,el){el.parentNode.replaceChild(noteEditor.getDoc().createTextNode("\n"),el)});el.contentEditable="false";let childNode=el.firstChild;childNode.innerHTML=noteEditor.dom.encode(childNode.textContent);hljs.highlightElement(childNode);el.className=noteEditor.$.trim(el.className)})})}});noteEditor.on("PreProcess",function(e){noteEditor.$("pre[contenteditable=false]",e.node).filter(function(key,el){return isCodeBlock(el)}).each(function(key,el){noteEditor.$(el).removeAttr("contentEditable");let code=el.textContent;let childNode=el.firstChild;noteEditor.$(childNode).empty();childNode.textContent=code})});noteEditor.on("click",function(e){let el=e.target;let node=noteEditor.$(el).closest("pre");if(node.length>0&&isCodeBlock(node[0])){document.getElementsByClassName("mce-i-codeblock")[0].firstChild.firstChild.setAttribute("fill","#0095ff")}else{document.getElementsByClassName("mce-i-codeblock")[0].firstChild.firstChild.setAttribute("fill","#505a64")}});noteEditor.on("dblclick",function(e){let el=e.target;let node=noteEditor.$(el).closest("pre");if(node.length>0&&isCodeBlock(node[0])){openCodeBlockEditor()}});function loadJs(srcUrl){return new Promise((resolve,reject)=>{const scriptNodes=[].slice.call(document.querySelectorAll("script")).map((item)=>item.src);if(scriptNodes.includes(srcUrl))return resolve();const script=document.createElement("script");script.type="text/javascript"})}function loadJs(srcUrl){return new Promise((resolve,reject)=>{if(srcUrl=="")return resolve();const scriptNodes=[].slice.call(document.querySelectorAll("script")).map((item)=>item.src);if(scriptNodes.includes(srcUrl))return resolve();const script=document.createElement("script");script.type="text/javascript";script.src=srcUrl;document.body.appendChild(script);script.onload=()=>{resolve()};script.onerror=(err)=>{reject(err)}})}function loadCss(hrefUrl){return new Promise((resolve,reject)=>{if(hrefUrl=="")return resolve();const linkNodes=[].slice.call(document.querySelectorAll("link")).map((item)=>item.href);if(linkNodes.includes(hrefUrl))return resolve();const link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=hrefUrl;document.head.appendChild(link);link.onload=()=>{resolve()};link.onerror=(err)=>{reject(err)}})}function addCss(cssText,id){let element=document.getElementById(id);element&&element.remove();element=document.createElement("style");id&&(element.id=id);element.type="text/css";element.appendChild(document.createTextNode(cssText));document.head.appendChild(element)}function formatHTML(html){let tab="\t";let result="";let indent="";html.split(/>\s*</).forEach(function(element){if(element.match(/^\/\w/)){indent=indent.substring(tab.length)}result+=indent+"<"+element+">\r\n";if(element.match(/^<?\w[^>]*[^\/]$/)&&!element.startsWith("input")){indent+=tab}});return result.substring(1,result.length-3)}function openFullscreen(cm){if(cm&&!cm.getOption("fullScreen"))cm.setOption("fullScreen",true)}function closeFullscreen(cm){if(cm&&cm.getOption("fullScreen"))cm.setOption("fullScreen",false)}function completeAfter(cm,pred){var cur=cm.getCursor();if(!pred||pred())setTimeout(function(){if(!cm.state.completionActive)cm.showHint({completeSingle:false})},100);return CodeMirror.Pass}function completeIfAfterLt(cm){return completeAfter(cm,function(){var cur=cm.getCursor();return cm.getRange(CodeMirror.Pos(cur.line,cur.ch-1),cur)=="<"})}function completeIfInTag(cm){return completeAfter(cm,function(){var tok=cm.getTokenAt(cm.getCursor());if(tok.type=="string"&&(!/['"]/.test(tok.string.charAt(tok.string.length-1))||tok.string.length==1))return false;var inner=CodeMirror.innerMode(cm.getMode(),tok.state).state;return inner.tagName})}function highlightJsExtension(result){let rules={bash:[{condition:[/(^|\|\s*)(\w+)(?!\w)/gm],overwrite:"$1<span class='hljs-built_in'>$2</span>",},{condition:[/(?<!\S)(-{1,2}[A-Za-z0-9]*)(?!\w)/gm],overwrite:"<span class='hljs-attr'>$1</span>",},],};let rule=rules[result.language];if(rule){for(let i in rule){for(let j in rule[i]["condition"]){let str=result.value;htmls=str.match(/<[^>]*>[^<]*<\/[^>]*>/g);for(let m in htmls){str=str.replace(/<[^>]*>[^<]*<\/[^>]*>/,"#"+m+"#")}str=str.replace(rule[i]["condition"][j],rule[i]["overwrite"]);for(let m in htmls){str=str.replace("#"+m+"#",htmls[m])}result.value=str}}}}function convertLanugaeMIME(language){map={bash:"text/x-sh",c:"text/x-csrc",cpp:"text/x-c++src",csharp:"text/x-csharp",css:"text/css",diff:"text/x-diff",go:"text/x-go",ini:"text/x-properties",java:"text/x-java",javascript:"text/javascript",json:"application/json",kotlin:"text/x-kotlin",less:"text/x-less",lua:"text/x-lua",makefile:"text/x-cmake",markdown:"text/x-markdown",objectivec:"text/x-objectivec",perl:"text/x-perl",php:"application/x-httpd-php","php-template":"text/x-php",plaintext:"",python:"text/x-python","python-repl":"text/x-cython",r:"text/x-rsrc",ruby:"text/x-ruby",rust:"rust",scss:"text/x-scss",shell:"text/x-sh",sql:"text/x-sql",swift:"text/x-swift",typescript:"application/typescript",vbnet:"text/x-vb",xml:"application/xml",yaml:"text/x-yaml",};return map[language]?map[language]:""}return{getMetadata:function(){return{name:pluginName}},}});